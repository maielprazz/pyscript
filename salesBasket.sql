CREATE TABLE ip_tmp_top200
AS
SELECT '8100078728' Itemcode UNION
SELECT '8100113902' Itemcode UNION
SELECT '8100119412' Itemcode UNION
SELECT '8100078729' Itemcode UNION
SELECT '8100075886' Itemcode UNION
SELECT '8100075950' Itemcode UNION
SELECT '8100075447' Itemcode UNION
SELECT '8100078465' Itemcode UNION
SELECT '8100113906' Itemcode UNION
SELECT '8100078813' Itemcode UNION
SELECT '8100076133' Itemcode UNION
SELECT '8100078820' Itemcode UNION
SELECT '8100078529' Itemcode UNION
SELECT '8100076134' Itemcode UNION
SELECT '8100075430' Itemcode UNION
SELECT '8100078528' Itemcode UNION
SELECT '8100075445' Itemcode UNION
SELECT '8100079064' Itemcode UNION
SELECT '8100078304' Itemcode UNION
SELECT '8100113907' Itemcode UNION
SELECT '8100078104' Itemcode UNION
SELECT '8100075446' Itemcode UNION
SELECT '8100075282' Itemcode UNION
SELECT '8100075651' Itemcode UNION
SELECT '8100078704' Itemcode UNION
SELECT '8100078730' Itemcode UNION
SELECT '8100075905' Itemcode UNION
SELECT '8100075949' Itemcode UNION
SELECT '8100075951' Itemcode UNION
SELECT '8100075159' Itemcode UNION
SELECT '8100120336' Itemcode UNION
SELECT '8100078726' Itemcode UNION
SELECT '8100076569' Itemcode UNION
SELECT '8100078532' Itemcode UNION
SELECT '8100076359' Itemcode UNION
SELECT '8100075947' Itemcode UNION
SELECT '8100075828' Itemcode UNION
SELECT '8100078809' Itemcode UNION
SELECT '8100078940' Itemcode UNION
SELECT '8100113905' Itemcode UNION
SELECT '8100076607' Itemcode UNION
SELECT '8100076111' Itemcode UNION
SELECT '8100079033' Itemcode UNION
SELECT '8100075181' Itemcode UNION
SELECT '8100078941' Itemcode UNION
SELECT '8100078453' Itemcode UNION
SELECT '8100075948' Itemcode UNION
SELECT '8100076583' Itemcode UNION
SELECT '8100075436' Itemcode UNION
SELECT '8100075202' Itemcode UNION
SELECT '8100127905' Itemcode UNION
SELECT '8100075349' Itemcode UNION
SELECT '8100075714' Itemcode UNION
SELECT '8100076504' Itemcode UNION
SELECT '8100075201' Itemcode UNION
SELECT '8100075179' Itemcode UNION
SELECT '8100075266' Itemcode UNION
SELECT '8100075295' Itemcode UNION
SELECT '8100076568' Itemcode UNION
SELECT '8100076532' Itemcode UNION
SELECT '8100075861' Itemcode UNION
SELECT '8100078433' Itemcode UNION
SELECT '8100076596' Itemcode UNION
SELECT '8100075431' Itemcode UNION
SELECT '8100075870' Itemcode UNION
SELECT '8100075787' Itemcode UNION
SELECT '8100075878' Itemcode UNION
SELECT '8100075315' Itemcode UNION
SELECT '8100078605' Itemcode UNION
SELECT '8100075812' Itemcode UNION
SELECT '8100075742' Itemcode UNION
SELECT '8100075871' Itemcode UNION
SELECT '8100076360' Itemcode UNION
SELECT '8100075348' Itemcode UNION
SELECT '8100078922' Itemcode UNION
SELECT '8100075449' Itemcode UNION
SELECT '8100075880' Itemcode UNION
SELECT '8100078177' Itemcode UNION
SELECT '8100075274' Itemcode UNION
SELECT '8100075320' Itemcode UNION
SELECT '8100078437' Itemcode UNION
SELECT '8100076274' Itemcode UNION
SELECT '8100078919' Itemcode UNION
SELECT '8100075444' Itemcode UNION
SELECT '8100075751' Itemcode UNION
SELECT '8100075879' Itemcode UNION
SELECT '8100076251' Itemcode UNION
SELECT '8100078690' Itemcode UNION
SELECT '8100076589' Itemcode UNION
SELECT '8100078351' Itemcode UNION
SELECT '8100075881' Itemcode UNION
SELECT '8100079032' Itemcode UNION
SELECT '8100075221' Itemcode UNION
SELECT '8100128617' Itemcode UNION
SELECT '8100078501' Itemcode UNION
SELECT '8100075203' Itemcode UNION
SELECT '8100075198' Itemcode UNION
SELECT '8100113904' Itemcode UNION
SELECT '8100136752' Itemcode UNION
SELECT '8100076155' Itemcode UNION
SELECT '8100078818' Itemcode UNION
SELECT '8100076538' Itemcode UNION
SELECT '8100078810' Itemcode UNION
SELECT '8100076169' Itemcode UNION
SELECT '8100078189' Itemcode UNION
SELECT '8100079071' Itemcode UNION
SELECT '8100075919' Itemcode UNION
SELECT '8100078725' Itemcode UNION
SELECT '8100075885' Itemcode UNION
SELECT '8100075903' Itemcode UNION
SELECT '8100075979' Itemcode UNION
SELECT '8100078812' Itemcode UNION
SELECT '8100076371' Itemcode UNION
SELECT '8100076575' Itemcode UNION
SELECT '8100078987' Itemcode UNION
SELECT '8100076482' Itemcode UNION
SELECT '8100076097' Itemcode UNION
SELECT '8100076428' Itemcode UNION
SELECT '8100076049' Itemcode UNION
SELECT '8100078455' Itemcode UNION
SELECT '8100076536' Itemcode UNION
SELECT '8100075180' Itemcode UNION
SELECT '8100075421' Itemcode UNION
SELECT '8100076098' Itemcode UNION
SELECT '8100078514' Itemcode UNION
SELECT '8100075145' Itemcode UNION
SELECT '8100076636' Itemcode UNION
SELECT '8100076168' Itemcode UNION
SELECT '8100075409' Itemcode UNION
SELECT '8100120334' Itemcode UNION
SELECT '8100075666' Itemcode UNION
SELECT '8100078852' Itemcode UNION
SELECT '8100076618' Itemcode UNION
SELECT '8100075968' Itemcode UNION
SELECT '8100075664' Itemcode UNION
SELECT '8100076163' Itemcode UNION
SELECT '8100075265' Itemcode UNION
SELECT '8100076565' Itemcode UNION
SELECT '8100075127' Itemcode UNION
SELECT '8100076576' Itemcode UNION
SELECT '8100075813' Itemcode UNION
SELECT '8100078457' Itemcode UNION
SELECT '8100136699' Itemcode UNION
SELECT '8100078918' Itemcode UNION
SELECT '8100078986' Itemcode UNION
SELECT '8100078516' Itemcode UNION
SELECT '8100076531' Itemcode UNION
SELECT '8100075712' Itemcode UNION
SELECT '8100075154' Itemcode UNION
SELECT '8100112990' Itemcode UNION
SELECT '8100113908' Itemcode UNION
SELECT '8100079020' Itemcode UNION
SELECT '8100075318' Itemcode UNION
SELECT '8100078828' Itemcode UNION
SELECT '8100078459' Itemcode UNION
SELECT '8100075888' Itemcode UNION
SELECT '8100075925' Itemcode UNION
SELECT '8100075632' Itemcode UNION
SELECT '8100076358' Itemcode UNION
SELECT '8100076106' Itemcode UNION
SELECT '8100075843' Itemcode UNION
SELECT '8100078561' Itemcode UNION
SELECT '8100078982' Itemcode UNION
SELECT '8100078843' Itemcode UNION
SELECT '8100075294' Itemcode UNION
SELECT '8100076430' Itemcode UNION
SELECT '8100076537' Itemcode UNION
SELECT '8100075810' Itemcode UNION
SELECT '8100075633' Itemcode UNION
SELECT '8100076547' Itemcode UNION
SELECT '8100078702' Itemcode UNION
SELECT '8100075288' Itemcode UNION
SELECT '8100127906' Itemcode UNION
SELECT '8100075924' Itemcode UNION
SELECT '8100078776' Itemcode UNION
SELECT '8100075923' Itemcode UNION
SELECT '8100078183' Itemcode UNION
SELECT '8100076396' Itemcode UNION
SELECT '8100075375' Itemcode UNION
SELECT '8100076515' Itemcode UNION
SELECT '8100075809' Itemcode UNION
SELECT '8100078796' Itemcode UNION
SELECT '8100075818' Itemcode UNION
SELECT '8100078994' Itemcode UNION
SELECT '8100076331' Itemcode UNION
SELECT '8100075247' Itemcode UNION
SELECT '8100078947' Itemcode UNION
SELECT '8100128604' Itemcode UNION
SELECT '8100078471' Itemcode UNION
SELECT '8100078358' Itemcode UNION
SELECT '8100075395' Itemcode UNION
SELECT '8100075255' Itemcode UNION
SELECT '8100076498' Itemcode UNION
SELECT '8100078984' Itemcode UNION
SELECT '8100078727' Itemcode UNION
SELECT '8100078431' Itemcode UNION
SELECT '8100075661' Itemcode UNION
SELECT '8100078571' Itemcode UNION
SELECT '8100078847' Itemcode UNION
SELECT '8100075319' Itemcode
select * from ip_tmp_top200

create index ix_3M on ip_tmp_top200 (itemcode)
DROP TABLE ip_tmp_sales3M
CREATE TABLE ip_tmp_sales3M
AS
SELECT 	SALES_DATE, SALES_NUMBER, ITEM_ID_OLD, ITEM_CODE_OLD, ITEM_CODE, ITEM_NAME, 
		ITEM_CATEGORY, ITEM_DEPARTEMENT, ITEM_DIVISION, ITEM_GROUP, 
		DESCRIPTION, BRAND, QTY, PARENT_QTY, 
		TOTAL_PRICE_AFTER_TAX, TOTAL_PRICE_BEFORE_TAX
FROM xilnex_rpt.tr_tbl_sales_by_item a
WHERE SALES_DATE BETWEEN '20231123' AND '20240222'
AND ITEM_CODE IN (select ITEMCODE FROM ip_tmp_top200)
AND a.SALES_STATUS not like 'CANCEL%'

create index ixips3m on ip_tmp_sales3M (sales_date, sales_number, item_code)

DROP table ip_tmp_sales3M_SN
create table ip_tmp_sales3M_SN
AS
SELECT 	SALES_DATE, SALES_NUMBER, ITEM_ID_OLD, ITEM_CODE_OLD, ITEM_CODE, ITEM_NAME, 
		ITEM_CATEGORY, ITEM_DEPARTEMENT, ITEM_DIVISION, ITEM_GROUP, 
		DESCRIPTION, BRAND, QTY, PARENT_QTY, 
		TOTAL_PRICE_AFTER_TAX, TOTAL_PRICE_BEFORE_TAX
FROM xilnex_rpt.tr_tbl_sales_by_item a
WHERE SALES_DATE BETWEEN '20231123' AND '20240222'
AND SALES_NUMBER IN (SELECT DISTINCT SALES_NUMBER 
FROM ip_tmp_sales3M 
)
AND a.SALES_STATUS not like 'CANCEL%'

create index ixjj on ip_tmp_sales3M_SN (sales_date, sales_number, item_code)


-- itemcode salesnumber
DROP table ip_itemcode_sn
CREATE table ip_itemcode_sn
AS
select a.item_code, a.SALES_NUMBER 
from ip_tmp_sales3M_SN a
WHERE a.item_code IN (select ITEMCODE FROM ip_tmp_top200)
GROUP BY a.item_code, a.SALES_NUMBER

create index ixitmsn on ip_itemcode_sn (item_code, sales_number)

-- itemcross
DROP table ip_trx_itemcross
create table ip_trx_itemcross
AS
SELECT b.Item_code itemcross, COUNT(distinct b.SALES_NUMBER) transaksi 
FROM ip_tmp_sales3M_SN b
WHERE b.Item_code not in (select ITEMCODE FROM ip_tmp_top200) 
GROUP BY b.Item_code 


-- sales number vs cross item
drop table ip_itemcross_sn
create table ip_itemcross_sn
As
select DISTINCT a.SALES_NUMBER, a.Item_code itemcross 
from ip_tmp_sales3M_SN a
WHERE a.Item_code not in (select ITEMCODE FROM ip_tmp_top200)

create index ixip_itemcross_sn on ip_itemcross_sn (sales_number)

select * from ip_tmp_sales3M
select * from ip_trx_itemcross
select * from ip_itemcode_sn
select * from ip_itemcross_sn


-- result
drop table ip_result_crossitem
create table ip_result_crossitem
as
select a.item_code, b.Itemcross, COUNT(distinct a.SALES_NUMBER) trx 
from ip_itemcode_sn a
JOIN ip_itemcross_sn b ON a.Sales_number = b.SALES_NUMBER
GROUP BY a.item_code, b.Itemcross

create index ix_rslt ON ip_result_crossitem (item_code, itemcross)

select a.ITEM_CODE ItemCodeTop, d1.ITEM_NAME ItemNameTop, d1.ITEM_CATEGORY ItemCategoryTop, d1.ITEM_GROUP ItemGroupTop, 
	   a.ItemCross, d2.ITEM_NAME ItemNameCross, d2.ITEM_CATEGORY ItemCategoryCross, d2.ITEM_GROUP ItemGroupCross,	
	   a.Trx
from ip_result_crossitem a
LEFT JOIN (select DISTINCT ITEM_CODE, ITEM_CATEGORY, ITEM_GROUP, ITEM_NAME FROM ip_tmp_sales3M_SN) d1 
	ON a.ITEM_CODE = d1.ITEM_CODE
LEFT JOIN (select DISTINCT ITEM_CODE, ITEM_CATEGORY, ITEM_GROUP, ITEM_NAME FROM ip_tmp_sales3M_SN) d2 
	ON a.ITEMCROSS = d2.ITEM_CODE
order by 1, a.trx desc

-- ======= End




select * from tr_tbl_sales_by_item ttsbi  WHERE  ITEM_CODE = '8100078728'

ip_result_crossitem 


select a.item_code, b.Itemcross, COUNT(distinct a.SALES_NUMBER) trx 
from ip_itemcode_sn a
JOIN ip_itemcross_sn b ON a.Sales_number = b.SALES_NUMBER
WHERE a.Item_code = '8100075742'
-- and a.sales_number = 3409119
GROUP BY a.item_code, b.Itemcross


-- testing 
select a.SALES_NUMBER, a.ITEM_CODE, c.ITEM_CODE itemcross 
from ip_tmp_sales3M_SN a
JOIN (select b.SALES_NUMBER, b.ITEM_CODE 
		from ip_tmp_sales3M_SN b
		where b.item_code = '8100075382'
) c ON c.SALES_NUMBER = a.SALES_NUMBER
where a.item_code = '8100075742'
order by 1

select a.SALES_NUMBER, a.ITEM_CODE 
from ip_tmp_sales3M_SN 
where item_code = '8100075382'




8100075742	8100075382	11

select a.Item_code, a.sales_number, b.Item_code itemcross, COUNT(distinct b.Item_code) transaksi 
from ip_itemcode_sn a
LEFT JOIN ip_tmp_sales3M_SN b 
	ON a.SALES_NUMBER = b.SALES_NUMBER
	AND a.ITEM_CODE <> b.Item_code

limit 100


select a.ITEMCODE 
from ip_tmp_top200 a
LEFT JOIN 



